<?phpdefine('IN_ECS', true);require dirname(__FILE__) . '/includes/init.php';require_once ROOT_PATH . '/' . ADMIN_PATH . '/includes/lib_goods.php';include_once ROOT_PATH . '/includes/cls_image.php';if ($_REQUEST['act'] == 'test') {    $smarty->assign('random', mt_rand());    $smarty->display('test.htm');}else if ($_REQUEST['act'] == 'goods_list') {    $smarty->display('partner_goods_list.dwt');}else if ($_REQUEST['act'] == 'platform_goods_list') {    get_del_goodsimg_null();    get_del_goods_gallery();    get_updel_goods_attr();    get_del_goods_video();    $sql = 'DELETE FROM' . $GLOBALS['ecs']->table('products_changelog') . 'WHERE admin_id = \'' . $_SESSION['admin_id'] . '\'';    $GLOBALS['db']->query($sql);    $smarty->assign('file_list', get_contents_section());    $ur_here = $_LANG['01_platform_goods'];    $smarty->assign('ur_here', $ur_here);    $smarty->assign('lang', $_LANG);    $suppliers_list = suppliers_list_info(' is_check = 1 ');    $suppliers_list_count = count($suppliers_list);    $smarty->assign('suppliers_list', $suppliers_list_count == 0 ? 0 : $suppliers_list);    $_REQUEST['is_on_sale'] = 1;    $goods_list = goods_list(0, -1, '', 3, 0);    $smarty->assign('goods_list', $goods_list['goods']);    $smarty->assign('filter', $goods_list['filter']);    $smarty->assign('record_count', $goods_list['record_count']);    $smarty->assign('page_count', $goods_list['page_count']);    $smarty->assign('full_page', 1);    $sort_flag = sort_flag($goods_list['filter']);    $smarty->assign($sort_flag['tag'], $sort_flag['img']);    $specifications = get_goods_type_specifications();    $smarty->assign('specifications', $specifications);    $store_list = get_common_store_list();    $smarty->assign('store_list', $store_list);    $smarty->assign('nowTime', gmtime());    set_default_filter();    if (isset($_GET['self'])) {        $smarty->assign('self', 1);    }    else if (isset($_GET['merchants'])) {        $smarty->assign('merchants', 1);    }    $smarty->assign('cfg', $_CFG);    $smarty->assign('transport_list', get_table_date('goods_transport', 'ru_id=\'' . $adminru['ru_id'] . '\'', array('tid, title'), 1));    assign_query_info();    $smarty->display('partner_platform_goods_list.dwt');}else if ($_REQUEST['act'] == 'partner_allot_goods') {    get_del_goodsimg_null();    get_del_goods_gallery();    get_updel_goods_attr();    get_del_goods_video();    $sql = 'DELETE FROM' . $GLOBALS['ecs']->table('products_changelog') . 'WHERE admin_id = \'' . $_SESSION['admin_id'] . '\'';    $GLOBALS['db']->query($sql);    $smarty->assign('file_list', get_contents_section());    $ur_here = $_LANG['01_platform_goods'];    $smarty->assign('ur_here', $ur_here);    $smarty->assign('lang', $_LANG);    $suppliers_list = suppliers_list_info(' is_check = 1 ');    $suppliers_list_count = count($suppliers_list);    $smarty->assign('suppliers_list', $suppliers_list_count == 0 ? 0 : $suppliers_list);    $_REQUEST['is_on_sale'] = 1;    $goods_list = goods_list(0, -1, $conditions, 3, 0);    $smarty->assign('goods_list', $goods_list['goods']);    $smarty->assign('user_id', $_REQUEST['id']);    $smarty->assign('filter', $goods_list['filter']);    $smarty->assign('record_count', $goods_list['record_count']);    $smarty->assign('page_count', $goods_list['page_count']);    $smarty->assign('full_page', 1);    $sort_flag = sort_flag($goods_list['filter']);    $smarty->assign($sort_flag['tag'], $sort_flag['img']);    $specifications = get_goods_type_specifications();    $smarty->assign('specifications', $specifications);    $store_list = get_common_store_list();    $smarty->assign('store_list', $store_list);    $smarty->assign('nowTime', gmtime());    set_default_filter();    if (isset($_GET['self'])) {        $smarty->assign('self', 1);    }    else if (isset($_GET['merchants'])) {        $smarty->assign('merchants', 1);    }    $smarty->assign('cfg', $_CFG);    $smarty->assign('transport_list', get_table_date('goods_transport', 'ru_id=\'' . $adminru['ru_id'] . '\'', array('tid, title'), 1));    assign_query_info();    $smarty->display('privilege_partner_allot_goods.dwt');}else if ($_REQUEST['act'] == 'set_exclusive_price') {    $goods_ids = trim($_POST['goods_ids']);    $user_id = trim($_POST['user_id']);    $price = trim($_POST['price']);    if (empty($goods_ids) || empty($user_id) || empty($price)) {        make_json_result($goods_ids, $_LANG['illegal_parameter'], ['code' => 400]);    }    $partner_manager_info = get_partner_manager_info($user_id);    $db->query('DELETE FROM ' . $ecs->table('partner_goods_config') . " WHERE goods_id IN ({$goods_ids}) AND company_id = " . $partner_manager_info['PartnerCompany']['id']);    $value = [];    $goods_ids = explode(',', $goods_ids);    foreach ($goods_ids as $goods_id) {        $value[] = '(' . $partner_manager_info['PartnerCompany']['id'] . ',' . $goods_id . ',' . $price . ',\'' . date('Y-m-d H:i:s', time()) . '\',\'' . date('Y-m-d H:i:s', time()) . '\')';    }    $value_str = implode(',', $value);    $sql = 'INSERT INTO ' . $ecs->table('partner_goods_config') . '(company_id, goods_id, price, created, updated) ' . ' VALUES ' . $value_str;    if ($db->query($sql)) {        make_json_result($goods_ids, $_LANG['success'], ['code' => 200]);    }}else if ($_REQUEST['act'] == 'query') {    $code = empty($_REQUEST['extension_code']) ? '' : trim($_REQUEST['extension_code']);    $goods_list = goods_list(0, -1, '', 3, 0);    $handler_list = array();    $handler_list['virtual_card'][] = array('url' => 'virtual_card.php?act=card', 'title' => $_LANG['card'], 'img' => 'icon_send_bonus.gif');    $handler_list['virtual_card'][] = array('url' => 'virtual_card.php?act=replenish', 'title' => $_LANG['replenish'], 'img' => 'icon_add.gif');    $handler_list['virtual_card'][] = array('url' => 'virtual_card.php?act=batch_card_add', 'title' => $_LANG['batch_card_add'], 'img' => 'icon_output.gif');    if (isset($handler_list[$code])) {        $smarty->assign('add_handler', $handler_list[$code]);    }    $smarty->assign('code', $code);    $smarty->assign('goods_list', $goods_list['goods']);    $smarty->assign('filter', $goods_list['filter']);    $smarty->assign('record_count', $goods_list['record_count']);    $smarty->assign('page_count', $goods_list['page_count']);    $smarty->assign('use_storage', empty($_CFG['use_storage']) ? 0 : 1);    $sort_flag = sort_flag($goods_list['filter']);    $smarty->assign($sort_flag['tag'], $sort_flag['img']);    $specifications = get_goods_type_specifications();    $smarty->assign('specifications', $specifications);    $tpl = 'partner_platform_goods_list.dwt';    $store_list = get_common_store_list();    $smarty->assign('store_list', $store_list);    $smarty->assign('nowTime', gmtime());    $smarty->assign('transport_list', get_table_date('goods_transport', 'ru_id=\'' . $adminru['ru_id'] . '\'', array('tid, title'), 1));    set_default_filter();    make_json_result($smarty->fetch($tpl), '', array('filter' => $goods_list['filter'], 'page_count' => $goods_list['page_count']));}else if ($_REQUEST['act'] == 'query_privilege_partner_allot_goods'){    $code = empty($_REQUEST['extension_code']) ? '' : trim($_REQUEST['extension_code']);    $goods_list = goods_list(0, -1, '', 3, 0);    $handler_list = array();    $handler_list['virtual_card'][] = array('url' => 'virtual_card.php?act=card', 'title' => $_LANG['card'], 'img' => 'icon_send_bonus.gif');    $handler_list['virtual_card'][] = array('url' => 'virtual_card.php?act=replenish', 'title' => $_LANG['replenish'], 'img' => 'icon_add.gif');    $handler_list['virtual_card'][] = array('url' => 'virtual_card.php?act=batch_card_add', 'title' => $_LANG['batch_card_add'], 'img' => 'icon_output.gif');    if (isset($handler_list[$code])) {        $smarty->assign('add_handler', $handler_list[$code]);    }    $smarty->assign('code', $code);    $smarty->assign('goods_list', $goods_list['goods']);    $smarty->assign('filter', $goods_list['filter']);    $smarty->assign('record_count', $goods_list['record_count']);    $smarty->assign('page_count', $goods_list['page_count']);    $smarty->assign('use_storage', empty($_CFG['use_storage']) ? 0 : 1);    $sort_flag = sort_flag($goods_list['filter']);    $smarty->assign($sort_flag['tag'], $sort_flag['img']);    $specifications = get_goods_type_specifications();    $smarty->assign('specifications', $specifications);    $tpl = 'privilege_partner_allot_goods.dwt';    $store_list = get_common_store_list();    $smarty->assign('store_list', $store_list);    $smarty->assign('nowTime', gmtime());    $smarty->assign('transport_list', get_table_date('goods_transport', 'ru_id=\'' . $adminru['ru_id'] . '\'', array('tid, title'), 1));    set_default_filter();    make_json_result($smarty->fetch($tpl), '', array('filter' => $goods_list['filter'], 'page_count' => $goods_list['page_count']));}